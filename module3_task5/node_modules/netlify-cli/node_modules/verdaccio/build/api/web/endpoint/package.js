"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _constants = require("../../../lib/constants");
var _logger = require("../../../lib/logger");
var _utils = require("../../../lib/utils");
var _user = require("../../../utils/user");
var _middleware = require("../../middleware");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
const getOrder = (order = 'asc') => {
  return order === 'asc';
};
function addPackageWebApi(storage, auth, config) {
  const can = (0, _middleware.allow)(auth);
  const pkgRouter = (0, _express.Router)(); /* eslint new-cap: 0 */

  const checkAllow = (name, remoteUser) => new Promise((resolve, reject) => {
    try {
      auth.allow_access({
        packageName: name
      }, remoteUser, (err, allowed) => {
        if (err) {
          resolve(false);
        }
        resolve(allowed);
      });
    } catch (err) {
      reject(err);
    }
  });

  // Get list of all visible package
  pkgRouter.get('/packages', function (req, res, next) {
    storage.getLocalDatabase(async function (err, packages) {
      if (err) {
        throw err;
      }
      async function processPackages(packages = []) {
        const permissions = [];
        const packgesCopy = packages.slice();
        for (const pkg of packgesCopy) {
          const pkgCopy = _objectSpread({}, pkg);
          pkgCopy.author = (0, _utils.formatAuthor)(pkg.author);
          try {
            if (await checkAllow(pkg.name, req.remote_user)) {
              if (config.web) {
                pkgCopy.author.avatar = (0, _user.generateGravatarUrl)(pkgCopy.author.email, config.web.gravatar);
              }
              if (!_lodash.default.isNil(pkgCopy.dist) && !_lodash.default.isNull(pkgCopy.dist.tarball)) {
                pkgCopy.dist.tarball = (0, _utils.getLocalRegistryTarballUri)(pkgCopy.dist.tarball, pkg.name, req, config.url_prefix);
              }
              permissions.push(pkgCopy);
            }
          } catch (err) {
            _logger.logger.error({
              name: pkg.name,
              error: err
            }, 'permission process for @{name} has failed: @{error}');
            throw err;
          }
        }
        return permissions;
      }
      const {
        web
      } = config;
      // @ts-ignore
      const order = config.web ? getOrder(web.sort_packages) : true;
      try {
        next((0, _utils.sortByName)(await processPackages(packages), order));
      } catch (error) {
        next(_utils.ErrorCode.getInternalError());
      }
    });
  });

  // Get package readme
  pkgRouter.get('/package/readme/(@:scope/)?:package/:version?', can('access'), function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      req,
      callback: function (err, info) {
        if (err) {
          return next(err);
        }
        res.set(_constants.HEADER_TYPE.CONTENT_TYPE, _constants.HEADERS.TEXT_PLAIN);
        const referer = req.get('Referer');
        const pathname = referer ? new URL(referer).pathname : undefined;
        next((0, _utils.parseReadme)(info.name, info.readme));
      }
    });
  });
  pkgRouter.get('/sidebar/(@:scope/)?:package', can('access'), function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      keepUpLinkData: true,
      req,
      callback: function (err, info) {
        if (_lodash.default.isNil(err)) {
          const {
            v
          } = req.query;
          let sideBarInfo = _lodash.default.clone(info);
          sideBarInfo.versions = (0, _utils.convertDistRemoteToLocalTarballUrls)(info, req, config.url_prefix).versions;
          if ((0, _utils.isVersionValid)(info, v)) {
            // @ts-ignore
            sideBarInfo.latest = sideBarInfo.versions[v];
            sideBarInfo.latest.author = (0, _utils.formatAuthor)(sideBarInfo.latest.author);
          } else {
            var _sideBarInfo;
            sideBarInfo.latest = sideBarInfo.versions[info[_constants.DIST_TAGS].latest];
            if ((_sideBarInfo = sideBarInfo) !== null && _sideBarInfo !== void 0 && _sideBarInfo.latest) {
              sideBarInfo.latest.author = (0, _utils.formatAuthor)(sideBarInfo.latest.author);
            } else {
              res.status(_constants.HTTP_STATUS.NOT_FOUND);
              res.end();
              return;
            }
          }
          sideBarInfo = (0, _utils.deleteProperties)(['readme', '_attachments', '_rev', 'name'], sideBarInfo);
          if (config.web) {
            sideBarInfo = (0, _utils.addGravatarSupport)(sideBarInfo, config.web.gravatar);
          } else {
            sideBarInfo = (0, _utils.addGravatarSupport)(sideBarInfo);
          }
          next(sideBarInfo);
        } else {
          res.status(_constants.HTTP_STATUS.NOT_FOUND);
          res.end();
        }
      }
    });
  });
  return pkgRouter;
}
var _default = addPackageWebApi;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRPcmRlciIsIm9yZGVyIiwiYWRkUGFja2FnZVdlYkFwaSIsInN0b3JhZ2UiLCJhdXRoIiwiY29uZmlnIiwiY2FuIiwiYWxsb3ciLCJwa2dSb3V0ZXIiLCJSb3V0ZXIiLCJjaGVja0FsbG93IiwibmFtZSIsInJlbW90ZVVzZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImFsbG93X2FjY2VzcyIsInBhY2thZ2VOYW1lIiwiZXJyIiwiYWxsb3dlZCIsImdldCIsInJlcSIsInJlcyIsIm5leHQiLCJnZXRMb2NhbERhdGFiYXNlIiwicGFja2FnZXMiLCJwcm9jZXNzUGFja2FnZXMiLCJwZXJtaXNzaW9ucyIsInBhY2tnZXNDb3B5Iiwic2xpY2UiLCJwa2ciLCJwa2dDb3B5IiwiYXV0aG9yIiwiZm9ybWF0QXV0aG9yIiwicmVtb3RlX3VzZXIiLCJ3ZWIiLCJhdmF0YXIiLCJnZW5lcmF0ZUdyYXZhdGFyVXJsIiwiZW1haWwiLCJncmF2YXRhciIsIl8iLCJpc05pbCIsImRpc3QiLCJpc051bGwiLCJ0YXJiYWxsIiwiZ2V0TG9jYWxSZWdpc3RyeVRhcmJhbGxVcmkiLCJ1cmxfcHJlZml4IiwicHVzaCIsImxvZ2dlciIsImVycm9yIiwic29ydF9wYWNrYWdlcyIsInNvcnRCeU5hbWUiLCJFcnJvckNvZGUiLCJnZXRJbnRlcm5hbEVycm9yIiwicGFyYW1zIiwic2NvcGUiLCJhZGRTY29wZSIsInBhY2thZ2UiLCJnZXRQYWNrYWdlIiwidXBsaW5rc0xvb2siLCJjYWxsYmFjayIsImluZm8iLCJzZXQiLCJIRUFERVJfVFlQRSIsIkNPTlRFTlRfVFlQRSIsIkhFQURFUlMiLCJURVhUX1BMQUlOIiwicmVmZXJlciIsInBhdGhuYW1lIiwiVVJMIiwidW5kZWZpbmVkIiwicGFyc2VSZWFkbWUiLCJyZWFkbWUiLCJrZWVwVXBMaW5rRGF0YSIsInYiLCJxdWVyeSIsInNpZGVCYXJJbmZvIiwiY2xvbmUiLCJ2ZXJzaW9ucyIsImNvbnZlcnREaXN0UmVtb3RlVG9Mb2NhbFRhcmJhbGxVcmxzIiwiaXNWZXJzaW9uVmFsaWQiLCJsYXRlc3QiLCJESVNUX1RBR1MiLCJzdGF0dXMiLCJIVFRQX1NUQVRVUyIsIk5PVF9GT1VORCIsImVuZCIsImRlbGV0ZVByb3BlcnRpZXMiLCJhZGRHcmF2YXRhclN1cHBvcnQiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXBpL3dlYi9lbmRwb2ludC9wYWNrYWdlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgQ29uZmlnLCBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmltcG9ydCB7IERJU1RfVEFHUywgSEVBREVSUywgSEVBREVSX1RZUEUsIEhUVFBfU1RBVFVTIH0gZnJvbSAnLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7XG4gIEVycm9yQ29kZSxcbiAgYWRkR3JhdmF0YXJTdXBwb3J0LFxuICBhZGRTY29wZSxcbiAgY29udmVydERpc3RSZW1vdGVUb0xvY2FsVGFyYmFsbFVybHMsXG4gIGRlbGV0ZVByb3BlcnRpZXMsXG4gIGZvcm1hdEF1dGhvcixcbiAgZ2V0TG9jYWxSZWdpc3RyeVRhcmJhbGxVcmksXG4gIGlzVmVyc2lvblZhbGlkLFxuICBwYXJzZVJlYWRtZSxcbiAgc29ydEJ5TmFtZSxcbn0gZnJvbSAnLi4vLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCB7ICROZXh0RnVuY3Rpb25WZXIsICRSZXF1ZXN0RXh0ZW5kLCAkUmVzcG9uc2VFeHRlbmQsICRTaWRlYmFyUGFja2FnZSwgSUF1dGgsIElTdG9yYWdlSGFuZGxlciB9IGZyb20gJy4uLy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IGdlbmVyYXRlR3JhdmF0YXJVcmwgfSBmcm9tICcuLi8uLi8uLi91dGlscy91c2VyJztcbmltcG9ydCB7IGFsbG93IH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZSc7XG5cbmNvbnN0IGdldE9yZGVyID0gKG9yZGVyID0gJ2FzYycpID0+IHtcbiAgcmV0dXJuIG9yZGVyID09PSAnYXNjJztcbn07XG5cbmV4cG9ydCB0eXBlIFBhY2tjYWdlRXh0ID0gUGFja2FnZSAmIHsgYXV0aG9yOiBhbnk7IGRpc3Q/OiB7IHRhcmJhbGw6IHN0cmluZyB9IH07XG5cbmZ1bmN0aW9uIGFkZFBhY2thZ2VXZWJBcGkoc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyLCBhdXRoOiBJQXV0aCwgY29uZmlnOiBDb25maWcpOiBSb3V0ZXIge1xuICBjb25zdCBjYW4gPSBhbGxvdyhhdXRoKTtcbiAgY29uc3QgcGtnUm91dGVyID0gUm91dGVyKCk7IC8qIGVzbGludCBuZXctY2FwOiAwICovXG5cbiAgY29uc3QgY2hlY2tBbGxvdyA9IChuYW1lLCByZW1vdGVVc2VyKTogUHJvbWlzZTxib29sZWFuPiA9PlxuICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpOiB2b2lkID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF1dGguYWxsb3dfYWNjZXNzKHsgcGFja2FnZU5hbWU6IG5hbWUgfSwgcmVtb3RlVXNlciwgKGVyciwgYWxsb3dlZCk6IHZvaWQgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKGFsbG93ZWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAvLyBHZXQgbGlzdCBvZiBhbGwgdmlzaWJsZSBwYWNrYWdlXG4gIHBrZ1JvdXRlci5nZXQoJy9wYWNrYWdlcycsIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIHN0b3JhZ2UuZ2V0TG9jYWxEYXRhYmFzZShhc3luYyBmdW5jdGlvbiAoZXJyLCBwYWNrYWdlcyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG5cbiAgICAgIGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NQYWNrYWdlcyhwYWNrYWdlczogUGFja2NhZ2VFeHRbXSA9IFtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnM6IFBhY2tjYWdlRXh0W10gPSBbXTtcbiAgICAgICAgY29uc3QgcGFja2dlc0NvcHkgPSBwYWNrYWdlcy5zbGljZSgpO1xuICAgICAgICBmb3IgKGNvbnN0IHBrZyBvZiBwYWNrZ2VzQ29weSkge1xuICAgICAgICAgIGNvbnN0IHBrZ0NvcHkgPSB7IC4uLnBrZyB9O1xuICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yID0gZm9ybWF0QXV0aG9yKHBrZy5hdXRob3IpO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoYXdhaXQgY2hlY2tBbGxvdyhwa2cubmFtZSwgcmVxLnJlbW90ZV91c2VyKSkge1xuICAgICAgICAgICAgICBpZiAoY29uZmlnLndlYikge1xuICAgICAgICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yLmF2YXRhciA9IGdlbmVyYXRlR3JhdmF0YXJVcmwocGtnQ29weS5hdXRob3IuZW1haWwsIGNvbmZpZy53ZWIuZ3JhdmF0YXIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmICghXy5pc05pbChwa2dDb3B5LmRpc3QpICYmICFfLmlzTnVsbChwa2dDb3B5LmRpc3QudGFyYmFsbCkpIHtcbiAgICAgICAgICAgICAgICBwa2dDb3B5LmRpc3QudGFyYmFsbCA9IGdldExvY2FsUmVnaXN0cnlUYXJiYWxsVXJpKHBrZ0NvcHkuZGlzdC50YXJiYWxsLCBwa2cubmFtZSwgcmVxLCBjb25maWcudXJsX3ByZWZpeCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcGVybWlzc2lvbnMucHVzaChwa2dDb3B5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcih7IG5hbWU6IHBrZy5uYW1lLCBlcnJvcjogZXJyIH0sICdwZXJtaXNzaW9uIHByb2Nlc3MgZm9yIEB7bmFtZX0gaGFzIGZhaWxlZDogQHtlcnJvcn0nKTtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGVybWlzc2lvbnM7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgd2ViIH0gPSBjb25maWc7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBjb25zdCBvcmRlcjogYm9vbGVhbiA9IGNvbmZpZy53ZWIgPyBnZXRPcmRlcih3ZWIuc29ydF9wYWNrYWdlcykgOiB0cnVlO1xuXG4gICAgICB0cnkge1xuICAgICAgICBuZXh0KHNvcnRCeU5hbWUoYXdhaXQgcHJvY2Vzc1BhY2thZ2VzKHBhY2thZ2VzKSwgb3JkZXIpKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIG5leHQoRXJyb3JDb2RlLmdldEludGVybmFsRXJyb3IoKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIEdldCBwYWNrYWdlIHJlYWRtZVxuICBwa2dSb3V0ZXIuZ2V0KCcvcGFja2FnZS9yZWFkbWUvKEA6c2NvcGUvKT86cGFja2FnZS86dmVyc2lvbj8nLCBjYW4oJ2FjY2VzcycpLCBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICBjb25zdCBwYWNrYWdlTmFtZSA9IHJlcS5wYXJhbXMuc2NvcGUgPyBhZGRTY29wZShyZXEucGFyYW1zLnNjb3BlLCByZXEucGFyYW1zLnBhY2thZ2UpIDogcmVxLnBhcmFtcy5wYWNrYWdlO1xuXG4gICAgc3RvcmFnZS5nZXRQYWNrYWdlKHtcbiAgICAgIG5hbWU6IHBhY2thZ2VOYW1lLFxuICAgICAgdXBsaW5rc0xvb2s6IHRydWUsXG4gICAgICByZXEsXG4gICAgICBjYWxsYmFjazogZnVuY3Rpb24gKGVyciwgaW5mbyk6IHZvaWQge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlcy5zZXQoSEVBREVSX1RZUEUuQ09OVEVOVF9UWVBFLCBIRUFERVJTLlRFWFRfUExBSU4pO1xuICAgICAgICBjb25zdCByZWZlcmVyID0gcmVxLmdldCgnUmVmZXJlcicpO1xuICAgICAgICBjb25zdCBwYXRobmFtZSA9IHJlZmVyZXIgPyBuZXcgVVJMKHJlZmVyZXIpLnBhdGhuYW1lIDogdW5kZWZpbmVkO1xuICAgICAgICBuZXh0KHBhcnNlUmVhZG1lKGluZm8ubmFtZSwgaW5mby5yZWFkbWUpKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHBrZ1JvdXRlci5nZXQoJy9zaWRlYmFyLyhAOnNjb3BlLyk/OnBhY2thZ2UnLCBjYW4oJ2FjY2VzcycpLCBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICBjb25zdCBwYWNrYWdlTmFtZTogc3RyaW5nID0gcmVxLnBhcmFtcy5zY29wZSA/IGFkZFNjb3BlKHJlcS5wYXJhbXMuc2NvcGUsIHJlcS5wYXJhbXMucGFja2FnZSkgOiByZXEucGFyYW1zLnBhY2thZ2U7XG5cbiAgICBzdG9yYWdlLmdldFBhY2thZ2Uoe1xuICAgICAgbmFtZTogcGFja2FnZU5hbWUsXG4gICAgICB1cGxpbmtzTG9vazogdHJ1ZSxcbiAgICAgIGtlZXBVcExpbmtEYXRhOiB0cnVlLFxuICAgICAgcmVxLFxuICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnI6IEVycm9yLCBpbmZvOiAkU2lkZWJhclBhY2thZ2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKF8uaXNOaWwoZXJyKSkge1xuICAgICAgICAgIGNvbnN0IHsgdiB9ID0gcmVxLnF1ZXJ5O1xuICAgICAgICAgIGxldCBzaWRlQmFySW5mbzogYW55ID0gXy5jbG9uZShpbmZvKTtcbiAgICAgICAgICBzaWRlQmFySW5mby52ZXJzaW9ucyA9IGNvbnZlcnREaXN0UmVtb3RlVG9Mb2NhbFRhcmJhbGxVcmxzKGluZm8sIHJlcSwgY29uZmlnLnVybF9wcmVmaXgpLnZlcnNpb25zO1xuICAgICAgICAgIGlmIChpc1ZlcnNpb25WYWxpZChpbmZvLCB2KSkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgc2lkZUJhckluZm8ubGF0ZXN0ID0gc2lkZUJhckluZm8udmVyc2lvbnNbdl07XG4gICAgICAgICAgICBzaWRlQmFySW5mby5sYXRlc3QuYXV0aG9yID0gZm9ybWF0QXV0aG9yKHNpZGVCYXJJbmZvLmxhdGVzdC5hdXRob3IpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzaWRlQmFySW5mby5sYXRlc3QgPSBzaWRlQmFySW5mby52ZXJzaW9uc1tpbmZvW0RJU1RfVEFHU10ubGF0ZXN0XTtcbiAgICAgICAgICAgIGlmIChzaWRlQmFySW5mbz8ubGF0ZXN0KSB7XG4gICAgICAgICAgICAgIHNpZGVCYXJJbmZvLmxhdGVzdC5hdXRob3IgPSBmb3JtYXRBdXRob3Ioc2lkZUJhckluZm8ubGF0ZXN0LmF1dGhvcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCk7XG4gICAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBzaWRlQmFySW5mbyA9IGRlbGV0ZVByb3BlcnRpZXMoWydyZWFkbWUnLCAnX2F0dGFjaG1lbnRzJywgJ19yZXYnLCAnbmFtZSddLCBzaWRlQmFySW5mbyk7XG4gICAgICAgICAgaWYgKGNvbmZpZy53ZWIpIHtcbiAgICAgICAgICAgIHNpZGVCYXJJbmZvID0gYWRkR3JhdmF0YXJTdXBwb3J0KHNpZGVCYXJJbmZvLCBjb25maWcud2ViLmdyYXZhdGFyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2lkZUJhckluZm8gPSBhZGRHcmF2YXRhclN1cHBvcnQoc2lkZUJhckluZm8pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBuZXh0KHNpZGVCYXJJbmZvKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCk7XG4gICAgICAgICAgcmVzLmVuZCgpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcGtnUm91dGVyO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhZGRQYWNrYWdlV2ViQXBpO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTtBQUNBO0FBSUE7QUFDQTtBQUNBO0FBYUE7QUFDQTtBQUF5QztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFFekMsTUFBTUEsUUFBUSxHQUFHLENBQUNDLEtBQUssR0FBRyxLQUFLLEtBQUs7RUFDbEMsT0FBT0EsS0FBSyxLQUFLLEtBQUs7QUFDeEIsQ0FBQztBQUlELFNBQVNDLGdCQUFnQixDQUFDQyxPQUF3QixFQUFFQyxJQUFXLEVBQUVDLE1BQWMsRUFBVTtFQUN2RixNQUFNQyxHQUFHLEdBQUcsSUFBQUMsaUJBQUssRUFBQ0gsSUFBSSxDQUFDO0VBQ3ZCLE1BQU1JLFNBQVMsR0FBRyxJQUFBQyxlQUFNLEdBQUUsQ0FBQyxDQUFDOztFQUU1QixNQUFNQyxVQUFVLEdBQUcsQ0FBQ0MsSUFBSSxFQUFFQyxVQUFVLEtBQ2xDLElBQUlDLE9BQU8sQ0FBQyxDQUFDQyxPQUFPLEVBQUVDLE1BQU0sS0FBVztJQUNyQyxJQUFJO01BQ0ZYLElB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